"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),_get=function e(t,r,o){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,r);if(void 0===n){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,o)}if("value"in n)return n.value;var i=n.get;if(void 0!==i)return i.call(o)},factory=function(e){var t=function(t){function r(e){var t=e.host,o=e.transaction_signer;_classCallCheck(this,r);var n=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return n.transaction_signer=o,n.global_nonces={},n}return _inherits(r,t),_createClass(r,[{key:"send",value:function(e,t){var o=this,n=e;n instanceof Array||(n=[n]);var a=!0,i=!1,s=void 0;try{for(var c,u=n[Symbol.iterator]();!(a=(c=u.next()).done);a=!0){var l=c.value;if("eth_sendTransaction"==l.method)throw new Error("HookedWeb3Provider does not support synchronous transactions. Please provide a callback.")}}catch(e){i=!0,s=e}finally{try{!a&&u.return&&u.return()}finally{if(i)throw s}}var p=function(n){return n?t(n):_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"send",o).call(o,e,t)};return this.rewritePayloads(0,n,{},p)}},{key:"sendAsync",value:function(e,t){var o=this,n=function(n){return n?t(n):void _get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"sendAsync",o).call(o,e,t)},a=e;e instanceof Array||(a=[e]),this.rewritePayloads(0,a,{},n)}},{key:"rewritePayloads",value:function(t,r,o,n){var a=this;if(t>=r.length)return n();var i=r[t],s=function(e){return null!=e?n(e):a.rewritePayloads(t+1,r,o,n)};if("eth_sendTransaction"!=i.method)return s();var c=i.params[0],u=c.from;this.transaction_signer.hasAddress(u,function(t,r){if(null!=t||0==r)return s(t);var l=function(t){var r=o[u];null!=r?t(null,r):a.sendAsync({jsonrpc:"2.0",method:"eth_getTransactionCount",params:[u,"pending"],id:(new Date).getTime()},function(r,o){if(null!=r)t(r);else{var n=o.result;t(null,e.prototype.toDecimal(n))}})};l(function(t,r){if(null!=t)return n(t);var l=Math.max(r,a.global_nonces[u]||0);c.nonce=e.prototype.toHex(l),o[u]=l+1,a.global_nonces[u]=l+1,a.transaction_signer.signTransaction(c,function(e,t){return null!=e?s(e):(i.method="eth_sendRawTransaction",i.params=[t],s())})})})}},{key:"prepareRequest",value:function(e){var t=_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"prepareRequest",this).call(this,e);if(!_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"host",this).match(/^https:/))return console.error("Refusing to send AUTHBAR.TOKEN over insecure connection"),t;try{var o=sessionStorage.getItem("AUTHBAR.TOKEN");if(o=JSON.parse(o).blockone,!o)throw!1;t.setRequestHeader("Authorization","Bearer "+o)}catch(e){console.error("No token found in sessionStorage AUTHBAR.TOKEN so sending request without token")}return t}}]),r}(e.providers.HttpProvider);return t};"undefined"!=typeof module?module.exports=factory(require("web3")):window.HookedWeb3Provider=factory(Web3);