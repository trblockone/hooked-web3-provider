"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in o)return o.value;var i=o.get;if(void 0!==i)return i.call(n)},factory=function(e){var t=function(t){function r(e){var t=e.host,n=e.transaction_signer;_classCallCheck(this,r);var o=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return o.transaction_signer=n,o.global_nonces={},o}return _inherits(r,t),_createClass(r,[{key:"send",value:function(e,t){var n=this,o=e;o instanceof Array||(o=[o]);var a=!0,i=!1,s=void 0;try{for(var c,u=o[Symbol.iterator]();!(a=(c=u.next()).done);a=!0){var l=c.value;if("eth_sendTransaction"==l.method)throw new Error("HookedWeb3Provider does not support synchronous transactions. Please provide a callback.")}}catch(e){i=!0,s=e}finally{try{!a&&u.return&&u.return()}finally{if(i)throw s}}var f=function(o){return o?t({source:"txsigning",error:o}):_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"send",n).call(n,e,t)};return this.rewritePayloads(0,o,{},f)}},{key:"sendAsync",value:function(e,t){var n=this,o=function(o){return o?t({source:"txsigning",error:o}):void _get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"sendAsync",n).call(n,e,t)},a=e;e instanceof Array||(a=[e]),this.rewritePayloads(0,a,{},o)}},{key:"rewritePayloads",value:function(t,r,n,o){var a=this;if(t>=r.length)return o();var i=r[t],s=function(e){return null!=e?o(e):a.rewritePayloads(t+1,r,n,o)};if("eth_sendTransaction"!=i.method)return s();var c=i.params[0],u=c.from;this.transaction_signer.hasAddress(u,function(t,r){if(null!=t||0==r)return s(t);var l=function(t){var r=n[u];null!=r?t(null,r):a.sendAsync({jsonrpc:"2.0",method:"eth_getTransactionCount",params:[u,"pending"],id:(new Date).getTime()},function(r,n){if(null!=r)t(r);else{var o=n.result;t(null,e.prototype.toDecimal(o))}})};l(function(t,r){if(null!=t)return o(t);var l=Math.max(r,a.global_nonces[u]||0);c.nonce=e.prototype.toHex(l),n[u]=l+1,a.global_nonces[u]=l+1,a.transaction_signer.signTransaction(c,function(e,t){return null!=e?s(e):(i.method="eth_sendRawTransaction",i.params=[t],s())})})})}}]),r}(e.providers.HttpProvider);return t};"undefined"!=typeof module?module.exports=factory(require("web3")):window.HookedWeb3Provider=factory(Web3);